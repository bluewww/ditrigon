/* SPDX-License_Identifier: GPL-2.0-or-later */
/* GTK4 character chart */

#include "fe-gtk4.h"

#include <string.h>

#define ASCII_UI_PATH "/org/ditrigon/ui/gtk4/dialogs/ascii-window.ui"

static GtkWidget *ascii_window;
static GtkWidget *ascii_info_label;

static const unsigned char table[] =
{
/* Line 1 */ '\n',
0xc2,0xa1,0xc2,0xbf,0xc2,0xa2,0xc2,0xa3,0xe2,0x82,0xac,0xc2,0xa5,0xc2,0xa6,0xc2,
0xa7,0xc2,0xa8,0xc2,0xa9,0xc2,0xae,0xc2,0xaa,0xc2,0xab,0xc2,0xbb,0xc2,0xac,0xc2,
0xad,0xc2,0xaf,0xe2,0x99,0xaa,
/* Line 2 */ '\n',
0xc2,0xba,0xc2,0xb9,0xc2,0xb2,0xc2,0xb3,0xc2,0xb4,0xc2,0xb5,0xc3,0x9e,0xc3,0xbe,
0xc2,0xb6,0xc2,0xb7,0xc2,0xb8,0xc2,0xb0,0xc2,0xbc,0xc2,0xbd,0xc2,0xbe,0xc3,0x97,
0xc2,0xb1,0xc3,0xb7,
/* Line 3 */ '\n',
0xc3,0x80,0xc3,0x81,0xc3,0x82,0xc3,0x83,0xc3,0x84,0xc3,0x85,0xc3,0x86,0xc4,0x82,
0xc4,0x84,0x20,0xc3,0x87,0xc4,0x86,0xc4,0x8c,0xc5,0x92,0x20,0xc4,0x8e,0xc4,0x90,
0x20,
/* Line 4 */ '\n',
0xc3,0xa0,0xc3,0xa1,0xc3,0xa2,0xc3,0xa3,0xc3,0xa4,0xc3,0xa5,0xc3,0xa6,0xc4,0x83,
0xc4,0x85,0x20,0xc3,0xa7,0xc4,0x87,0xc4,0x8d,0xc5,0x93,0x20,0xc4,0x8f,0xc4,0x91,
0x20,
/* Line 5 */ '\n',
0xc3,0x88,0xc3,0x89,0xc3,0x8a,0xc3,0x8b,0xc4,0x98,0xc4,0x9a,0x20,0xc4,0x9e,0x20,
0xc3,0x8c,0xc3,0x8d,0xc3,0x8e,0xc3,0x8f,0xc4,0xb0,0x20,0xc4,0xb9,0xc4,0xbd,0xc5,
0x81,
/* Line 6 */ '\n',
0xc3,0xa8,0xc3,0xa9,0xc3,0xaa,0xc3,0xab,0xc4,0x99,0xc4,0x9b,0x20,0xc4,0x9f,0x20,
0xc3,0xac,0xc3,0xad,0xc3,0xae,0xc3,0xaf,0xc4,0xb1,0x20,0xc4,0xba,0xc4,0xbe,0xc5,
0x82,
/* Line 7 */ '\n',
0xc3,0x91,0xc5,0x83,0xc5,0x87,0x20,0xc3,0x92,0xc3,0x93,0xc3,0x94,0xc3,0x95,0xc3,
0x96,0xc3,0x98,0xc5,0x90,0x20,0xc5,0x94,0xc5,0x98,0x20,0xc5,0x9a,0xc5,0x9e,0xc5,
0xa0,
/* Line 8 */ '\n',
0xc3,0xb1,0xc5,0x84,0xc5,0x88,0x20,0xc3,0xb2,0xc3,0xb3,0xc3,0xb4,0xc3,0xb5,0xc3,
0xb6,0xc3,0xb8,0xc5,0x91,0x20,0xc5,0x95,0xc5,0x99,0x20,0xc5,0x9b,0xc5,0x9f,0xc5,
0xa1,
/* Line 9 */ '\n',
0x20,0xc5,0xa2,0xc5,0xa4,0x20,0xc3,0x99,0xc3,0x9a,0xc3,0x9b,0xc5,0xb2,0xc3,0x9c,
0xc5,0xae,0xc5,0xb0,0x20,0xc3,0x9d,0xc3,0x9f,0x20,0xc5,0xb9,0xc5,0xbb,0xc5,0xbd,
/* Line 10 */ '\n',
0x20,0xc5,0xa3,0xc5,0xa5,0x20,0xc3,0xb9,0xc3,0xba,0xc3,0xbb,0xc5,0xb3,0xc3,0xbc,
0xc5,0xaf,0xc5,0xb1,0x20,0xc3,0xbd,0xc3,0xbf,0x20,0xc5,0xba,0xc5,0xbc,0xc5,0xbe,
/* Line 11 */ '\n',
0xd0,0x90,0xd0,0x91,0xd0,0x92,0xd0,0x93,0xd0,0x94,0xd0,0x95,0xd0,0x81,0xd0,0x96,
0xd0,0x97,0xd0,0x98,0xd0,0x99,0xd0,0x9a,0xd0,0x9b,0xd0,0x9c,0xd0,0x9d,0xd0,0x9e,
0xd0,0x9f,0xd0,0xa0,
/* Line 12 */ '\n',
0xd0,0xb0,0xd0,0xb1,0xd0,0xb2,0xd0,0xb3,0xd0,0xb4,0xd0,0xb5,0xd1,0x91,0xd0,0xb6,
0xd0,0xb7,0xd0,0xb8,0xd0,0xb9,0xd0,0xba,0xd0,0xbb,0xd0,0xbc,0xd0,0xbd,0xd0,0xbe,
0xd0,0xbf,0xd1,0x80,
/* Line 13 */ '\n',
0xd0,0xa1,0xd0,0xa2,0xd0,0xa3,0xd0,0xa4,0xd0,0xa5,0xd0,0xa6,0xd0,0xa7,0xd0,0xa8,
0xd0,0xa9,0xd0,0xaa,0xd0,0xab,0xd0,0xac,0xd0,0xad,0xd0,0xae,0xd0,0xaf,
/* Line 14 */ '\n',
0xd1,0x81,0xd1,0x82,0xd1,0x83,0xd1,0x84,0xd1,0x85,0xd1,0x86,0xd1,0x87,0xd1,0x88,
0xd1,0x89,0xd1,0x8a,0xd1,0x8b,0xd1,0x8c,0xd1,0x8d,0xd1,0x8e,0xd1,0x8f,0
};

static gboolean
ascii_close_request_cb (GtkWindow *window, gpointer userdata)
{
	(void) window;
	(void) userdata;

	ascii_window = NULL;
	ascii_info_label = NULL;
	return FALSE;
}

static void
ascii_insert_text (const char *text)
{
	int pos;

	if (!text || !text[0] || !command_entry)
		return;

	pos = gtk_editable_get_position (GTK_EDITABLE (command_entry));
	gtk_editable_insert_text (GTK_EDITABLE (command_entry), text, -1, &pos);
	gtk_editable_set_position (GTK_EDITABLE (command_entry), pos);
	gtk_widget_grab_focus (command_entry);
}

static void
ascii_click_cb (GtkButton *button, gpointer userdata)
{
	const char *text;
	char info[64];
	gunichar ch;

	(void) userdata;

	text = gtk_button_get_label (button);
	if (!text)
		return;

	ascii_insert_text (text);

	ch = g_utf8_get_char (text);
	g_snprintf (info, sizeof (info), "%s U+%04X", text, ch);
	if (ascii_info_label)
		gtk_label_set_text (GTK_LABEL (ascii_info_label), info);
}

void
ascii_open (void)
{
	GtkWidget *grid;
	GtkWidget *close_button;
	GtkBuilder *builder;
	const unsigned char *ptr;
	int row;
	int col;

	if (ascii_window)
	{
		gtk_window_present (GTK_WINDOW (ascii_window));
		return;
	}

	builder = fe_gtk4_builder_new_from_resource (ASCII_UI_PATH);
	ascii_window = fe_gtk4_builder_get_widget (builder, "ascii_window", GTK_TYPE_WINDOW);
	grid = fe_gtk4_builder_get_widget (builder, "ascii_grid", GTK_TYPE_GRID);
	ascii_info_label = fe_gtk4_builder_get_widget (builder, "ascii_info_label", GTK_TYPE_LABEL);
	close_button = fe_gtk4_builder_get_widget (builder, "ascii_close_button", GTK_TYPE_BUTTON);
	g_object_ref_sink (ascii_window);
	g_object_unref (builder);

	gtk_button_set_label (GTK_BUTTON (close_button), _("Close"));
	gtk_label_set_text (GTK_LABEL (ascii_info_label),
		_("Click a character to insert it into the input box."));
	g_signal_connect_swapped (close_button, "clicked",
		G_CALLBACK (gtk_window_close), ascii_window);
	g_signal_connect (ascii_window, "close-request",
		G_CALLBACK (ascii_close_request_cb), NULL);

	gtk_window_set_title (GTK_WINDOW (ascii_window), _("Character Chart"));
	if (main_window)
		gtk_window_set_transient_for (GTK_WINDOW (ascii_window), GTK_WINDOW (main_window));

	row = -1;
	col = 0;
	ptr = table;
	while (ptr[0] != 0)
	{
		if (ptr[0] == '\n')
		{
			row++;
			col = 0;
			ptr++;
			continue;
		}

		{
			GtkWidget *button;
			char text[8];
			int len;

			len = g_utf8_skip[ptr[0]];
			memcpy (text, ptr, len);
			text[len] = 0;

			button = gtk_button_new_with_label (text);
			gtk_widget_set_size_request (button, 32, -1);
			g_signal_connect (button, "clicked", G_CALLBACK (ascii_click_cb), NULL);
			gtk_grid_attach (GTK_GRID (grid), button, col, row, 1, 1);
			col++;
			ptr += len;
		}
	}

	gtk_window_present (GTK_WINDOW (ascii_window));
}

void
fe_gtk4_ascii_cleanup (void)
{
	if (!ascii_window)
		return;

	gtk_window_destroy (GTK_WINDOW (ascii_window));
	ascii_window = NULL;
	ascii_info_label = NULL;
}
